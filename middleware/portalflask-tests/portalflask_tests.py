import os
import unittest
import random

from numpy.testing import assert_array_equal
import numpy as np

import beampy

import portalflask.core.graph_support as graph_support
from portalflask.core.shapefile_support import ShapefileSupport
import portalflask.core.geometry_support as geometry_support

from portalflask.models.shape import Shape


class PortalTests(unittest.TestCase):


    @classmethod
    def setUpClass(cls):
        cls.db = DummyDb()
        cls.shapefile_support = ShapefileSupport(cls.db)
        cls.simple_shapefile = os.path.join(os.path.dirname(__file__), 'resources/countries.shp')
        cls.point_shapefile = os.path.join(os.path.dirname(__file__), 'resources/Basemap_test_WGS84_latlon.shp')
        cls.projected_shapefile = os.path.join(os.path.dirname(__file__), 'resources/schlick_shape.shp')
        PortalTests.addToDb(cls.db, cls.shapefile_support, cls.simple_shapefile)
        PortalTests.addToDb(cls.db, cls.shapefile_support, cls.point_shapefile)
        PortalTests.addToDb(cls.db, cls.shapefile_support, cls.projected_shapefile)
        cls.test_product_path = os.path.join(os.path.dirname(__file__), 'resources/test.nc')
        cls.product = beampy.ProductIO.readProduct(cls.test_product_path)


    @staticmethod
    def addToDb(db, shapefile_support, shapefile_path):
        shape_names = shapefile_support.get_shape_names(shapefile_path)
        for (record_number, shape_name) in shape_names:
            shape = Shape(record_number, shape_name)
            db.shapes.append(shape)


    def test_get_coordinate_variable(self):
        time_var = graph_support.get_coordinate_variable(self.product, 'Time')
        assert_array_equal(np.array([1.63965594E9], dtype=np.float32), time_var)

        none_var = graph_support.get_coordinate_variable(self.product, 'Kaputtnick')
        self.assertIsNone(none_var)


    def test_get_axis_units(self):
        self.assertEqual('meters', graph_support.get_axis_units(self.product, 'depth'))
        self.assertEqual('degrees_north', graph_support.get_axis_units(self.product, 'latitude'))
        self.assertIsNone(graph_support.get_axis_units(self.product, 'Godot'))


    def test_get_depth(self):
        self.assertAlmostEqual(1.4721018, graph_support.get_depth(self.product))


    def test_get_shape_geometry(self):
        expected_wkt = 'POLYGON((65.6272964478 37.3331985474, 65.6469268799 37.4588813782, 65.7013702393 37.5369300842, 65.7660827637 37.534160614, 65.7855224609 37.5688781738, 66.3027496338 37.323600769, 66.5387649536 37.3605117798, 66.5869064331 37.3680381775, 66.6652526855 37.3383216858, 66.7444229126 37.3613700867, 67.0216369629 37.3772010803, 67.2002563477 37.2466506958, 67.2294235229 37.1919288635, 67.2663726807 37.1852607727, 67.424407959 37.2349891663, 67.5216369629 37.272480011, 67.5574569702 37.2155418396, 67.6494064331 37.2460899353, 67.7741394043 37.2060890198, 67.7771530151 37.185798645, 67.7916412354 37.0883216858, 67.8855285645 37.0613708496, 67.9105224609 37.0144309998, 68.0355224609 36.9247093201, 68.2833099365 37.0199813843, 68.2783126831 37.0869293213, 68.3016433716 37.1110992432, 68.4130172729 37.1044311523, 68.4121932983 37.1480407715, 68.5249786377 37.1619300842, 68.6546936035 37.2469291687, 68.8258132935 37.2477607727, 68.8094024658 37.3224906921, 68.8502502441 37.3247108459, 68.9049682617 37.2722091675, 68.924407959 37.2847099304, 68.8916473389 37.317489624, 68.9996871948 37.3077583313, 69.2466278076 37.0941505432, 69.3330383301 37.1249809265, 69.4513702393 37.2299804688, 69.3813476562 37.3441505432, 69.3827362061 37.4558181763, 69.5158081055 37.5808181763, 69.9180297852 37.6119308472, 69.9585876465 37.5649909973, 70.134979248 37.5291481018, 70.2555389404 37.6210899353, 70.2769165039 37.7413711548, 70.1655273438 37.8722114563, 70.1702423096 37.9416503906, 70.2038574219 37.920539856, 70.3783035278 38.0577583313, 70.4919128418 38.1672096252, 70.5844116211 38.278591156, 70.5963592529 38.334148407, 70.6855163574 38.3752593994, 70.672203064 38.4144287109, 70.8805236816 38.4530410767, 71.1019134521 38.4060897827, 71.3630218506 38.2488708496, 71.363861084 38.1880302429, 71.2846984863 38.0199813843, 71.2641372681 37.9180488586, 71.3746795654 37.9058189392, 71.5463562012 37.9424781799, 71.5919189453 37.9030418396, 71.5885772705 37.8160896301, 71.5288467407 37.7644309998, 71.4902496338 37.284160614, 71.4469070435 37.2077598572, 71.4321899414 37.0585899353, 71.5683135986 36.7413711548, 71.6952362061 36.6722106934, 71.8427429199 36.6924781799, 72.0113677979 36.8121986389, 72.3466262817 36.9899787903, 72.6635894775 37.0260887146, 72.7988586426 37.2299804688, 73.0813598633 37.3205413818, 73.1505279541 37.4008216858, 73.3144073486 37.4633216858, 73.7766418457 37.4344291687, 73.7527618408 37.3313789368, 73.6494064331 37.3044281006, 73.6199569702 37.2627601624, 73.6344070435 37.2399787903, 73.7924728394 37.2294197083, 74.363861084 37.4286003113, 74.4008026123 37.3994293213, 74.6996917725 37.3919296265, 74.8988265991 37.2402992249, 74.8169326782 37.2191505432, 74.7633132935 37.3010902405, 74.669418335 37.2661018372, 74.6510772705 37.2347106934, 74.5371932983 37.2430381775, 74.3921966553 37.1752586365, 74.4005279541 37.1391487122, 74.5677490234 37.0264701843, 74.5580062866 36.965259552, 74.4821929932 37.011100769, 74.3369064331 36.9588813782, 74.2519226074 36.8994293213, 74.1588592529 36.9066505432, 74.0621795654 36.8216590881, 73.9630279541 36.8377609253, 73.7796936035 36.9010887146, 73.1130218506 36.8738708496, 72.4924621582 36.7719306946, 72.181640625 36.7147102356, 72.1916427612 36.6571998596, 72.0733032227 36.628868103, 72.0746917725 36.5894203186, 71.7958068848 36.4919281006, 71.8177490234 36.4166603088, 71.753036499 36.4074897766, 71.6466369629 36.4680404663, 71.5630187988 36.3724784851, 71.5827484131 36.3358192444, 71.2485809326 36.1330413818, 71.1880187988 36.0472106934, 71.2910766602 35.9685897827, 71.3805236816 35.9460906982, 71.5452423096 35.711101532, 71.5085906982 35.6266517639, 71.613861084 35.5619316101, 71.606918335 35.4819297791, 71.6472015381 35.4369392395, 71.5491333008 35.3283195496, 71.5535736084 35.289150238, 71.6591262817 35.2074890137, 71.6180267334 35.1313705444, 71.543296814 35.0946998596, 71.4960784912 34.9594306946, 71.3138580322 34.8869285583, 71.2255172729 34.744430542, 71.0958099365 34.676651001, 71.0949707031 34.5680503845, 70.9957962036 34.5585899353, 70.9780273438 34.5108184814, 71.0730285645 34.3941497803, 71.1533126831 34.3613700867, 71.1355285645 34.1660881042, 70.9810791016 34.0088806152, 70.9055328369 34.0133209229, 70.9005279541 33.9735908508, 70.4913482666 33.9430389404, 69.9027633667 34.0311012268, 69.9074707031 33.8819313049, 69.9855194092 33.7530403137, 70.1327362061 33.7355384827, 70.1966171265 33.6408195496, 70.1977386475 33.4858207703, 70.3060836792 33.3960990906, 70.3269195557 33.3319396973, 70.1449737549 33.2024917603, 70.0677490234 33.204990387, 70.0335769653 33.1394309998, 69.881072998 33.0899810791, 69.7913513184 33.1269416809, 69.5610809326 33.0819282532, 69.4924621582 33.0085983276, 69.5152587891 32.873878479, 69.3949737549 32.7738685608, 69.4569168091 32.6822090149, 69.3977508545 32.5877609253, 69.2874832153 32.5263786316, 69.2480163574 32.4438705444, 69.2830429077 32.2177696228, 69.2874832153 32.0691490173, 69.3338623047 31.9438896179, 69.0296936035 31.6455497742, 68.8330383301 31.6038799286, 68.731918335 31.6994400024, 68.7124786377 31.7788791656, 68.5474700928 31.8291606903, 68.4441223145 31.794719696, 68.4477386475 31.772769928, 68.5716400146 31.7652702332, 68.5377502441 31.7266597748, 68.2216262817 31.8155899048, 68.1660766602 31.8330497742, 67.9805297852 31.6358299255, 67.8874816895 31.6399898529, 67.7380218506 31.5308303833, 67.5810928345 31.5335998535, 67.6463623047 31.4099903107, 67.7669219971 31.4111003876, 67.799697876 31.3824901581, 67.7919235229 31.3411006927, 67.2880172729 31.2136001587, 67.256362915 31.2224903107, 67.0697021484 31.2391605377, 67.0346984863 31.2544403076, 67.0516433716 31.2977790833, 67.0369110107 31.3186092377, 66.8916473389 31.2961006165, 66.7230224609 31.2122097015, 66.6841278076 31.0861091614, 66.5663604736 30.9777698517, 66.4049682617 30.9461097717, 66.2819213867 30.5752696991, 66.3502502441 30.4505500793, 66.2596969604 30.1141605377, 66.2382965088 30.0713806152, 66.3613586426 29.9661006927, 66.2566375732 29.851940155, 65.4174728394 29.6405506134, 65.0341262817 29.5410995483, 64.6955108643 29.5863800049, 64.2738571167 29.5238895416, 64.1930236816 29.4874897003, 64.1313476562 29.394159317, 63.5872001648 29.5038795471, 62.7869300842 29.4338798523, 62.4844284058 29.4060993195, 61.743598938 29.6158294678, 60.9938697815 29.8260993958, 60.8668708801 29.8624305725, 61.2530403137 30.2599906921, 61.8127593994 30.8436107635, 61.8038711548 30.9458198547, 61.8472099304 31.0488796234, 61.7658195496 31.2452697754, 61.7710990906 31.3183307648, 61.7136001587 31.3833293915, 61.619430542 31.3958206177, 60.8438682556 31.4983291626, 60.8102607727 31.8736000061, 60.8577690125 32.2347183228, 60.7416496277 32.578868866, 60.5819282532 33.0716590881, 60.591091156 33.1630401611, 60.851650238 33.4180488586, 60.8583183289 33.4938697815, 60.9286003113 33.5044288635, 60.9016494751 33.5544281006, 60.6491508484 33.5749893188, 60.5227584839 33.6530418396, 60.5052604675 33.739151001, 60.5541496277 33.8133201599, 60.5213699341 33.9991493225, 60.5135993958 34.1508216858, 60.6716499329 34.3135986328, 60.9110908508 34.3163795471, 60.897769928 34.3458213806, 60.7566490173 34.4833183289, 60.7336006165 34.5416603088, 60.8636016846 34.5763893127, 61.0652618408 34.8127593994, 61.1138801575 35.2016487122, 61.1044311523 35.2791481018, 61.1861000061 35.2969398499, 61.239151001 35.4810905457, 61.277759552 35.5202598572, 61.2787208557 35.6067504883, 61.3658218384 35.6397094727, 61.4649887085 35.5272102356, 61.5766487122 35.4508209229, 61.8024787903 35.4110908508, 61.9722099304 35.459980011, 62.100818634 35.3947105408, 62.2591590881 35.2977714539, 62.3055381775 35.1455383301, 62.4594306946 35.2863807678, 62.6233100891 35.2249794006, 63.1105384827 35.4813690186, 63.0952606201 35.6260910034, 63.2388801575 35.6955299377, 63.1041603088 35.8258209229, 63.119430542 35.8619308472, 63.3172111511 35.8522109985, 63.5388793945 35.9097099304, 63.595539093 35.9622001648, 63.9338684082 36.039150238, 64.0638580322 36.0002708435, 64.0596923828 36.0880393982, 64.169418335 36.1674880981, 64.2824707031 36.1519203186, 64.3216400146 36.216381073, 64.4588623047 36.2472114563, 64.5705337524 36.3563804626, 64.627746582 36.459980011, 64.6152496338 36.6294288635, 64.7952423096 36.9230384827, 64.7791366577 37.0958213806, 64.7980194092 37.1249809265, 65.0727462769 37.244430542, 65.5308074951 37.2486000061, 65.6272964478 37.3331985474))'
        wkt = self.shapefile_support.get_shape_geometry(self.simple_shapefile, 'Afghanistan')
        self.assertEqual(expected_wkt, wkt)


    def test_get_shape_geometry_with_projection(self):
        expected_wkt = 'POLYGON((8.48530170301 53.9357868413, 8.48537786096 53.9357871676, 8.48537896688 53.9356972911, 8.4853028091 53.9356969648, 8.48530170301 53.9357868413))'
        wkt = self.shapefile_support.get_shape_geometry(self.projected_shapefile, 'Schlick')
        self.assertEqual(expected_wkt, wkt)


    def test_get_shape_geometry_multipolygon(self):
        expected_wkt = 'MULTIPOLYGON(((-14.3330602646 28.0444393158, -14.4738903046 28.0686092377, -14.4944496155 28.0997200012, -14.3091697693 28.1427707672, -14.2097196579 28.2280502319, -14.2025003433 28.294719696, -14.0877799988 28.4997196198, -14.0275001526 28.6230506897, -13.9724998474 28.729719162, -13.8658399582 28.7477703094, -13.8205604553 28.5772209167, -13.8558301926 28.4786090851, -13.8441696167 28.4022197723, -13.9502801895 28.2247200012, -14.1402797699 28.1836109161, -14.3330602646 28.0444393158)),((-14.3330602646 28.0444393158, -14.4738903046 28.0686092377, -14.4944496155 28.0997200012, -14.3091697693 28.1427707672, -14.2097196579 28.2280502319, -14.2025003433 28.294719696, -14.0877799988 28.4997196198, -14.0275001526 28.6230506897, -13.9724998474 28.729719162, -13.8658399582 28.7477703094, -13.8205604553 28.5772209167, -13.8558301926 28.4786090851, -13.8441696167 28.4022197723, -13.9502801895 28.2247200012, -14.1402797699 28.1836109161, -14.3330602646 28.0444393158)),((3.06361103058 39.2635993958, 2.90222191811 39.3597106934, 2.7930560112 39.3624916077, 2.72916698456 39.4677696228, 2.72250008583 39.5299911499, 2.6188890934 39.5502700806, 2.52361106873 39.4530410767, 2.35805511475 39.5574913025, 2.37305498123 39.6108207703, 2.66083288193 39.7627601624, 2.81583309174 39.8616600037, 3.13083291054 39.9174880981, 3.09194397926 39.9013710022, 3.11194396019 39.8663787842, 3.20527696609 39.8674888611, 3.15444397926 39.8347091675, 3.12388801575 39.8224906921, 3.14722204208 39.7794303894, 3.24777698517 39.7347106934, 3.45277690887 39.7499885559, 3.46361088753 39.6613807678, 3.29194402695 39.4724884033, 3.24194407463 39.3644294739, 3.06361103058 39.2635993958)),((3.06361103058 39.2635993958, 2.90222191811 39.3597106934, 2.7930560112 39.3624916077, 2.72916698456 39.4677696228, 2.72250008583 39.5299911499, 2.6188890934 39.5502700806, 2.52361106873 39.4530410767, 2.35805511475 39.5574913025, 2.37305498123 39.6108207703, 2.66083288193 39.7627601624, 2.81583309174 39.8616600037, 3.13083291054 39.9174880981, 3.09194397926 39.9013710022, 3.11194396019 39.8663787842, 3.20527696609 39.8674888611, 3.15444397926 39.8347091675, 3.12388801575 39.8224906921, 3.14722204208 39.7794303894, 3.24777698517 39.7347106934, 3.45277690887 39.7499885559, 3.46361088753 39.6613807678, 3.29194402695 39.4724884033, 3.24194407463 39.3644294739, 3.06361103058 39.2635993958)),((-15.5908298492 27.7347202301, -15.7852802277 27.8374900818, -15.8175001144 27.9386100769, -15.7083301544 28.0749893188, -15.7049999237 28.1658306122, -15.4663896561 28.1266593933, -15.4302797318 28.1497192383, -15.3719501495 27.8597202301, -15.5908298492 27.7347202301)),((-15.5908298492 27.7347202301, -15.7852802277 27.8374900818, -15.8175001144 27.9386100769, -15.7083301544 28.0749893188, -15.7049999237 28.1658306122, -15.4663896561 28.1266593933, -15.4302797318 28.1497192383, -15.3719501495 27.8597202301, -15.5908298492 27.7347202301)),((-16.6825008392 27.9869403839, -16.7813892365 28.129989624, -16.9041690826 28.3508300781, -16.5583305359 28.3936004639, -16.3761100769 28.536939621, -16.2366695404 28.5622196198, -16.1219501495 28.5769405365, -16.1186103821 28.5163803101, -16.3511104584 28.3580608368, -16.3494491577 28.2988796234, -16.5013904572 28.0491600037, -16.6825008392 27.9869403839)),((-16.6825008392 27.9869403839, -16.7813892365 28.129989624, -16.9041690826 28.3508300781, -16.5583305359 28.3936004639, -16.3761100769 28.536939621, -16.2366695404 28.5622196198, -16.1219501495 28.5769405365, -16.1186103821 28.5163803101, -16.3511104584 28.3580608368, -16.3494491577 28.2988796234, -16.5013904572 28.0491600037, -16.6825008392 27.9869403839)),((1.38305497169 38.8366508484, 1.27722203732 38.8797111511, 1.22249996662 38.8741493225, 1.24249994755 38.9680404663, 1.29222202301 39.0052604675, 1.35722196102 39.0697097778, 1.51972198486 39.1183204651, 1.60055494308 39.0960998535, 1.58500003815 39.0027694702, 1.41250002384 38.8905410767, 1.38305497169 38.8366508484)),((1.38305497169 38.8366508484, 1.27722203732 38.8797111511, 1.22249996662 38.8741493225, 1.24249994755 38.9680404663, 1.29222202301 39.0052604675, 1.35722196102 39.0697097778, 1.51972198486 39.1183204651, 1.60055494308 39.0960998535, 1.58500003815 39.0027694702, 1.41250002384 38.8905410767, 1.38305497169 38.8366508484)),((-13.773059845 28.837770462, -13.8638896942 28.8538799286, -13.8522195816 28.9063796997, -13.7936096191 29.0508308411, -13.5938901901 29.1380500793, -13.5513896942 29.1202697754, -13.4763898849 29.2419395447, -13.4224996567 29.2080497742, -13.4555597305 29.1427707672, -13.4816703796 28.9969406128, -13.773059845 28.837770462)),((-13.773059845 28.837770462, -13.8638896942 28.8538799286, -13.8522195816 28.9063796997, -13.7936096191 29.0508308411, -13.5938901901 29.1380500793, -13.5513896942 29.1202697754, -13.4763898849 29.2419395447, -13.4224996567 29.2080497742, -13.4555597305 29.1427707672, -13.4816703796 28.9969406128, -13.773059845 28.837770462)),((-17.8611106873 28.4766597748, -17.9705600739 28.7166595459, -17.995010376 28.778049469, -17.9044494629 28.849439621, -17.7813892365 28.8388805389, -17.7166690826 28.7405490875, -17.7569503784 28.673330307, -17.7391700745 28.6077709198, -17.7833404541 28.5291595459, -17.8155593872 28.480550766, -17.8611106873 28.4766597748)),((-17.8611106873 28.4766597748, -17.9705600739 28.7166595459, -17.995010376 28.778049469, -17.9044494629 28.849439621, -17.7813892365 28.8388805389, -17.7166690826 28.7405490875, -17.7569503784 28.673330307, -17.7391700745 28.6077709198, -17.7833404541 28.5291595459, -17.8155593872 28.480550766, -17.8611106873 28.4766597748)),((4.29527807236 39.8105506897, 4.11638784409 39.8683204651, 3.96555495262 39.9336013794, 3.82666611671 39.9224891663, 3.84055495262 39.9958190918, 3.80194401741 40.0022087097, 3.83138799667 40.0527610779, 4.13666582108 40.0635986328, 4.18083286285 40.0594291687, 4.22777700424 39.9961013794, 4.28749895096 39.9466590881, 4.33666610718 39.8724899292, 4.29527807236 39.8105506897)),((4.29527807236 39.8105506897, 4.11638784409 39.8683204651, 3.96555495262 39.9336013794, 3.82666611671 39.9224891663, 3.84055495262 39.9958190918, 3.80194401741 40.0022087097, 3.83138799667 40.0527610779, 4.13666582108 40.0635986328, 4.18083286285 40.0594291687, 4.22777700424 39.9961013794, 4.28749895096 39.9466590881, 4.33666610718 39.8724899292, 4.29527807236 39.8105506897)),((1.43524694443 42.5971488953, 1.44638800621 42.5722084045, 1.44833302498 42.4508209229, 1.53333294392 42.4361000061, 1.71096694469 42.4734992981, 1.78750002384 42.4902610779, 1.95305502415 42.4371986389, 1.97666597366 42.3746986389, 2.08694410324 42.363319397, 2.25416707993 42.4347114563, 2.47666597366 42.351650238, 2.67111110687 42.3383216858, 2.67833304405 42.4016494751, 3.03833293915 42.4749794006, 3.15083289146 42.4333190918, 3.1769618988 42.4376106262, 3.1875 42.3485984802, 3.31722211838 42.3249893188, 3.22222208977 42.2349891663, 3.15861105919 42.2624893188, 3.11083292961 42.1966590881, 3.13388895988 42.1183204651, 3.2025001049 42.0788803101, 3.17944407463 41.8741493225, 2.81944394112 41.6858215332, 2.49527692795 41.5485992432, 2.24972200394 41.4480400085, 2.12694406509 41.2955513, 1.66666698456 41.1997108459, 1.21333301067 41.1047096252, 1.0888890028 41.063041687, 0.993055522442 41.0480384827, 0.704166710377 40.813041687, 0.723055481911 40.7758293152, 0.894999980927 40.7283210754, 0.851666629314 40.6761016846, 0.635555505753 40.623878479, 0.546388924122 40.573600769, 0.261388808489 40.2083206177, 0.186388894916 40.165271759, 0.131944403052 40.0708198547, 0.0488888807595 40.0360984802, -0.0619444511831 39.863319397, -0.179444506764 39.7360992432, -0.33750000596 39.4405403137, -0.27500000596 39.2710990906, -0.108333297074 38.9458198547, 0.00888888724148 38.8622093201, 0.188888907433 38.8086013794, 0.236111104488 38.744430542, 0.033611100167 38.6294288635, -0.0505555607378 38.595539093, -0.0652777925134 38.5458183289, -0.399166703224 38.4085998535, -0.476388901472 38.3380393982, -0.517499983311 38.2944297791, -0.509166717529 38.2116508484, -0.612222313881 38.1788787842, -0.658055722713 38.0519294739, -0.683888912201 37.9688796997, -0.759444475174 37.8619308472, -0.747222304344 37.790271759, -0.787500023842 37.8133201599, -0.860000014305 37.7166481018, -0.74083340168 37.6302604675, -0.751111090183 37.7769317627, -0.69055557251 37.6313781738, -0.816666722298 37.5733184814, -1.26916694641 37.5552711487, -1.38444399834 37.5258293152, -1.76916694641 37.2452697754, -1.82135999203 37.2677497864, -1.7866859436 37.2469482422, -1.89722204208 36.9460983276, -1.99888896942 36.8841590881, -2.02500009537 36.8288803101, -2.17444491386 36.7202682495, -2.29888892174 36.8294296265, -2.55555605888 36.8147087097, -2.69694495201 36.681098938, -2.85972309113 36.6952705383, -2.92888903618 36.749710083, -3.52944493294 36.7158203125, -3.71388888359 36.7316589355, -3.90611100197 36.7416496277, -4.39833402634 36.7222099304, -4.67722177505 36.5016593933, -5.16555595398 36.415271759, -5.31138896942 36.2336006165, -5.34472322464 36.1499900818, -5.38166713715 36.1783218384, -5.43277788162 36.1741600037, -5.42222309113 36.0758209229, -5.6055560112 35.999710083, -5.77333402634 36.0772094727, -6.15166807175 36.2969398499, -6.26305580139 36.4816589355, -6.23333406448 36.4613800049, -6.17277812958 36.5122108459, -6.25027799606 36.5083198547, -6.23083400726 36.5749893188, -6.39250087738 36.6263809204, -6.44389009476 36.7188796997, -6.3555560112 36.7874908447, -6.3397231102 36.8894309998, -6.35805606842 36.794708252, -6.42055606842 36.8566589355, -6.5738902092 37.0158195496, -6.90472316742 37.1655387878, -6.9375 37.1938781738, -6.97222185135 37.2852592468, -6.95388889313 37.1722106934, -7.17472314835 37.2274894714, -7.38416719437 37.169708252, -7.41816520691 37.1733703613, -7.51416683197 37.5733184814, -7.29750013351 37.8480415344, -7.25472307205 37.9874916077, -7.14611101151 38.0052604675, -7.00694513321 38.0280418396, -6.94416618347 38.1627616882, -6.9480547905 38.2183189392, -7.08777809143 38.1744308472, -7.14416694641 38.2702598572, -7.30707120895 38.4255981445, -7.32972192764 38.4472007751, -7.30111122131 38.5249900818, -7.29225206375 38.5706596375, -7.26555585861 38.7083206177, -7.15583276749 38.790271759, -6.95388889313 39.0269317627, -6.96111106873 39.0566482544, -7.04055595398 39.1227607727, -7.11583280563 39.1041603088, -7.15416717529 39.1227607727, -7.13999986649 39.1733207703, -7.24305486679 39.2130393982, -7.23500013351 39.2763710022, -7.31361103058 39.3446998596, -7.29361200333 39.4677581787, -7.44249916077 39.5510902405, -7.53333282471 39.6688804626, -7.40777778625 39.6483192444, -7.01722192764 39.6749916077, -6.86388921738 40.0155410767, -7.01444482803 40.146648407, -7.00611114502 40.2308082581, -6.96083402634 40.2402610779, -6.78749990463 40.3416481018, -6.84833288193 40.4433097839, -6.79111099243 40.5180397034, -6.83916711807 40.5749893188, -6.79777812958 40.6577606201, -6.82944488525 40.7552604675, -6.79972219467 40.8560905457, -6.89166688919 40.9747009277, -6.92444419861 41.0313682556, -6.80861091614 41.0405387878, -6.68138885498 41.2155418396, -6.59833288193 41.2441482544, -6.43388795853 41.3224906921, -6.31861114502 41.3872108459, -6.32944488525 41.4152603149, -6.21777820587 41.5294303894, -6.19444417953 41.5930404663, -6.35583305359 41.6777610779, -6.49777793884 41.6574897766, -6.53944396973 41.6794281006, -6.56277799606 41.7452583313, -6.50861215591 41.8738708496, -6.56861114502 41.8872108459, -6.54500007629 41.9371986389, -6.58166694641 41.9674797058, -6.62805604935 41.9410896301, -6.80944395065 41.9902610779, -6.83777809143 41.9472007751, -7.1522231102 41.9885902405, -7.20055580139 41.8835983276, -7.42722177505 41.8124809265, -7.4569439888 41.8644294739, -7.52444505692 41.8405418396, -7.61194419861 41.834980011, -7.59166717529 41.8797111511, -7.70611095428 41.9044303894, -7.88000011444 41.852771759, -7.88611078262 41.9233207703, -7.91222190857 41.8897094727, -7.98194408417 41.8663787842, -8.14083480835 41.8091506958, -8.21888923645 41.9136009216, -8.08277702332 42.0252609253, -8.09000015259 42.0688781738, -8.18583297729 42.0647010803, -8.20138931274 42.1522102356, -8.62111091614 42.0536003113, -8.81239509583 41.9045295715, -8.87194633484 41.8758201599, -8.89861297607 42.1080513, -8.77833366394 42.2077598572, -8.61277961731 42.3155403137, -8.6252784729 42.3535995483, -8.68388938904 42.2797088623, -8.85750007629 42.2477607727, -8.85388946533 42.3077697754, -8.81361198425 42.2799911499, -8.83083343506 42.3427696228, -8.76722335815 42.340259552, -8.65638923645 42.4277610779, -8.84111213684 42.3913803101, -8.94222259521 42.4669303894, -8.87194633484 42.5008201599, -8.86972236633 42.4536018372, -8.80750083923 42.5047111511, -8.82777786255 42.5747108459, -8.73083496094 42.6610984802, -8.82500076294 42.6658210754, -8.85611152649 42.6077690125, -8.88639068604 42.6399917603, -9.01722335815 42.5213813782, -9.03527832031 42.5680503845, -9.08500099182 42.5763816833, -8.93361282349 42.772769928, -8.85611152649 42.8194389343, -8.90389060974 42.8283195496, -8.9538898468 42.7758293152, -9.06861114502 42.7547111511, -9.13583374023 42.7910995483, -9.10166740417 42.8233184814, -9.14194488525 42.8616600037, -9.18500137329 42.9524917603, -9.18139076233 42.9155387878, -9.24527931213 42.9219398499, -9.29333496094 42.9224891663, -9.27416801453 43.0247116089, -9.14555740356 43.1930503845, -9.02527809143 43.2130393982, -8.93472290039 43.2297096252, -8.98194503784 43.2761001587, -8.83750152588 43.3452682495, -8.72444534302 43.2910995483, -8.53944587708 43.3097114563, -8.405834198 43.3847084045, -8.38611221313 43.3394317627, -8.33555603027 43.3733215332, -8.32972335815 43.403881073, -8.21583366394 43.3305397034, -8.21666717529 43.3980407715, -8.28527832031 43.4327697754, -8.24111175537 43.4902610779, -8.33972358704 43.4569282532, -8.31944465637 43.562210083, -8.25361347198 43.5580406189, -8.08944511414 43.6619300842, -7.86583423615 43.7722091675, -7.85083389282 43.7147102356, -7.89916706085 43.6702690125, -7.85444498062 43.6683197021, -7.79083299637 43.7341499329, -7.68583393097 43.7744293213, -7.69361209869 43.7308197021, -7.6055560112 43.7133293152, -7.57055616379 43.7116508484, -7.484167099 43.727771759, -7.24888896942 43.5791511536, -7.03888893127 43.5574913025, -7.04527902603 43.4899902344, -6.94361114502 43.5777702332, -6.34972286224 43.5586013794, -6.16361093521 43.5722084045, -5.95472192764 43.5805397034, -5.8519449234 43.652759552, -5.52916717529 43.5485992432, -5.39805603027 43.5524902344, -5.38139009476 43.5261001587, -5.28888893127 43.533870697, -5.2147231102 43.4797096252, -4.69222307205 43.4174880981, -4.21694517136 43.3938789368, -4.05139017105 43.442489624, -3.82361102104 43.4488792419, -3.79722309113 43.4122085571, -3.65416693687 43.4916496277, -3.51555609703 43.4908218384, -3.43055605888 43.4644317627, -3.46055603027 43.4422111511, -3.42972207069 43.4110984802, -3.23138904572 43.3983192444, -3.11861109734 43.350818634, -3.00916695595 43.3810997009, -2.94166707993 43.4355506897, -2.72833299637 43.425819397, -2.29555606842 43.2961006165, -1.87999999523 43.3449897766, -1.81048798561 43.3858909607, -1.65583300591 43.3094291687, -1.62000000477 43.2563781738, -1.40916705132 43.2730407715, -1.381945014 43.1966514587, -1.47277796268 43.091091156, -1.44055604935 43.0483207703, -1.36027801037 43.0316505432, -1.28833305836 43.1060905457, -1.30055594444 43.0716590881, -0.818888902664 42.9460906982, -0.74694442749 42.9655418396, -0.656111121178 42.8636016846, -0.519166707993 42.7908210754, -0.500833392143 42.8222084045, -0.392222195864 42.7963790894, -0.306666702032 42.8491516113, -0.187777802348 42.7858200073, -0.123888902366 42.7574882507, -0.0575000010431 42.6941490173, 0.261944413185 42.7174797058, 0.291111111641 42.675819397, 0.41249999404 42.6952590942, 0.676110982895 42.6891517639, 0.668055415154 42.7480392456, 0.667777717113 42.8391494751, 0.815833091736 42.841091156, 1.38361096382 42.6897010803, 1.43524694443 42.5971488953)),((1.43524694443 42.5971488953, 1.44638800621 42.5722084045, 1.44833302498 42.4508209229, 1.53333294392 42.4361000061, 1.71096694469 42.4734992981, 1.78750002384 42.4902610779, 1.95305502415 42.4371986389, 1.97666597366 42.3746986389, 2.08694410324 42.363319397, 2.25416707993 42.4347114563, 2.47666597366 42.351650238, 2.67111110687 42.3383216858, 2.67833304405 42.4016494751, 3.03833293915 42.4749794006, 3.15083289146 42.4333190918, 3.1769618988 42.4376106262, 3.1875 42.3485984802, 3.31722211838 42.3249893188, 3.22222208977 42.2349891663, 3.15861105919 42.2624893188, 3.11083292961 42.1966590881, 3.13388895988 42.1183204651, 3.2025001049 42.0788803101, 3.17944407463 41.8741493225, 2.81944394112 41.6858215332, 2.49527692795 41.5485992432, 2.24972200394 41.4480400085, 2.12694406509 41.2955513, 1.66666698456 41.1997108459, 1.21333301067 41.1047096252, 1.0888890028 41.063041687, 0.993055522442 41.0480384827, 0.704166710377 40.813041687, 0.723055481911 40.7758293152, 0.894999980927 40.7283210754, 0.851666629314 40.6761016846, 0.635555505753 40.623878479, 0.546388924122 40.573600769, 0.261388808489 40.2083206177, 0.186388894916 40.165271759, 0.131944403052 40.0708198547, 0.0488888807595 40.0360984802, -0.0619444511831 39.863319397, -0.179444506764 39.7360992432, -0.33750000596 39.4405403137, -0.27500000596 39.2710990906, -0.108333297074 38.9458198547, 0.00888888724148 38.8622093201, 0.188888907433 38.8086013794, 0.236111104488 38.744430542, 0.033611100167 38.6294288635, -0.0505555607378 38.595539093, -0.0652777925134 38.5458183289, -0.399166703224 38.4085998535, -0.476388901472 38.3380393982, -0.517499983311 38.2944297791, -0.509166717529 38.2116508484, -0.612222313881 38.1788787842, -0.658055722713 38.0519294739, -0.683888912201 37.9688796997, -0.759444475174 37.8619308472, -0.747222304344 37.790271759, -0.787500023842 37.8133201599, -0.860000014305 37.7166481018, -0.74083340168 37.6302604675, -0.751111090183 37.7769317627, -0.69055557251 37.6313781738, -0.816666722298 37.5733184814, -1.26916694641 37.5552711487, -1.38444399834 37.5258293152, -1.76916694641 37.2452697754, -1.82135999203 37.2677497864, -1.7866859436 37.2469482422, -1.89722204208 36.9460983276, -1.99888896942 36.8841590881, -2.02500009537 36.8288803101, -2.17444491386 36.7202682495, -2.29888892174 36.8294296265, -2.55555605888 36.8147087097, -2.69694495201 36.681098938, -2.85972309113 36.6952705383, -2.92888903618 36.749710083, -3.52944493294 36.7158203125, -3.71388888359 36.7316589355, -3.90611100197 36.7416496277, -4.39833402634 36.7222099304, -4.67722177505 36.5016593933, -5.16555595398 36.415271759, -5.31138896942 36.2336006165, -5.34472322464 36.1499900818, -5.38166713715 36.1783218384, -5.43277788162 36.1741600037, -5.42222309113 36.0758209229, -5.6055560112 35.999710083, -5.77333402634 36.0772094727, -6.15166807175 36.2969398499, -6.26305580139 36.4816589355, -6.23333406448 36.4613800049, -6.17277812958 36.5122108459, -6.25027799606 36.5083198547, -6.23083400726 36.5749893188, -6.39250087738 36.6263809204, -6.44389009476 36.7188796997, -6.3555560112 36.7874908447, -6.3397231102 36.8894309998, -6.35805606842 36.794708252, -6.42055606842 36.8566589355, -6.5738902092 37.0158195496, -6.90472316742 37.1655387878, -6.9375 37.1938781738, -6.97222185135 37.2852592468, -6.95388889313 37.1722106934, -7.17472314835 37.2274894714, -7.38416719437 37.169708252, -7.41816520691 37.1733703613, -7.51416683197 37.5733184814, -7.29750013351 37.8480415344, -7.25472307205 37.9874916077, -7.14611101151 38.0052604675, -7.00694513321 38.0280418396, -6.94416618347 38.1627616882, -6.9480547905 38.2183189392, -7.08777809143 38.1744308472, -7.14416694641 38.2702598572, -7.30707120895 38.4255981445, -7.32972192764 38.4472007751, -7.30111122131 38.5249900818, -7.29225206375 38.5706596375, -7.26555585861 38.7083206177, -7.15583276749 38.790271759, -6.95388889313 39.0269317627, -6.96111106873 39.0566482544, -7.04055595398 39.1227607727, -7.11583280563 39.1041603088, -7.15416717529 39.1227607727, -7.13999986649 39.1733207703, -7.24305486679 39.2130393982, -7.23500013351 39.2763710022, -7.31361103058 39.3446998596, -7.29361200333 39.4677581787, -7.44249916077 39.5510902405, -7.53333282471 39.6688804626, -7.40777778625 39.6483192444, -7.01722192764 39.6749916077, -6.86388921738 40.0155410767, -7.01444482803 40.146648407, -7.00611114502 40.2308082581, -6.96083402634 40.2402610779, -6.78749990463 40.3416481018, -6.84833288193 40.4433097839, -6.79111099243 40.5180397034, -6.83916711807 40.5749893188, -6.79777812958 40.6577606201, -6.82944488525 40.7552604675, -6.79972219467 40.8560905457, -6.89166688919 40.9747009277, -6.92444419861 41.0313682556, -6.80861091614 41.0405387878, -6.68138885498 41.2155418396, -6.59833288193 41.2441482544, -6.43388795853 41.3224906921, -6.31861114502 41.3872108459, -6.32944488525 41.4152603149, -6.21777820587 41.5294303894, -6.19444417953 41.5930404663, -6.35583305359 41.6777610779, -6.49777793884 41.6574897766, -6.53944396973 41.6794281006, -6.56277799606 41.7452583313, -6.50861215591 41.8738708496, -6.56861114502 41.8872108459, -6.54500007629 41.9371986389, -6.58166694641 41.9674797058, -6.62805604935 41.9410896301, -6.80944395065 41.9902610779, -6.83777809143 41.9472007751, -7.1522231102 41.9885902405, -7.20055580139 41.8835983276, -7.42722177505 41.8124809265, -7.4569439888 41.8644294739, -7.52444505692 41.8405418396, -7.61194419861 41.834980011, -7.59166717529 41.8797111511, -7.70611095428 41.9044303894, -7.88000011444 41.852771759, -7.88611078262 41.9233207703, -7.91222190857 41.8897094727, -7.98194408417 41.8663787842, -8.14083480835 41.8091506958, -8.21888923645 41.9136009216, -8.08277702332 42.0252609253, -8.09000015259 42.0688781738, -8.18583297729 42.0647010803, -8.20138931274 42.1522102356, -8.62111091614 42.0536003113, -8.81239509583 41.9045295715, -8.87194633484 41.8758201599, -8.89861297607 42.1080513, -8.77833366394 42.2077598572, -8.61277961731 42.3155403137, -8.6252784729 42.3535995483, -8.68388938904 42.2797088623, -8.85750007629 42.2477607727, -8.85388946533 42.3077697754, -8.81361198425 42.2799911499, -8.83083343506 42.3427696228, -8.76722335815 42.340259552, -8.65638923645 42.4277610779, -8.84111213684 42.3913803101, -8.94222259521 42.4669303894, -8.87194633484 42.5008201599, -8.86972236633 42.4536018372, -8.80750083923 42.5047111511, -8.82777786255 42.5747108459, -8.73083496094 42.6610984802, -8.82500076294 42.6658210754, -8.85611152649 42.6077690125, -8.88639068604 42.6399917603, -9.01722335815 42.5213813782, -9.03527832031 42.5680503845, -9.08500099182 42.5763816833, -8.93361282349 42.772769928, -8.85611152649 42.8194389343, -8.90389060974 42.8283195496, -8.9538898468 42.7758293152, -9.06861114502 42.7547111511, -9.13583374023 42.7910995483, -9.10166740417 42.8233184814, -9.14194488525 42.8616600037, -9.18500137329 42.9524917603, -9.18139076233 42.9155387878, -9.24527931213 42.9219398499, -9.29333496094 42.9224891663, -9.27416801453 43.0247116089, -9.14555740356 43.1930503845, -9.02527809143 43.2130393982, -8.93472290039 43.2297096252, -8.98194503784 43.2761001587, -8.83750152588 43.3452682495, -8.72444534302 43.2910995483, -8.53944587708 43.3097114563, -8.405834198 43.3847084045, -8.38611221313 43.3394317627, -8.33555603027 43.3733215332, -8.32972335815 43.403881073, -8.21583366394 43.3305397034, -8.21666717529 43.3980407715, -8.28527832031 43.4327697754, -8.24111175537 43.4902610779, -8.33972358704 43.4569282532, -8.31944465637 43.562210083, -8.25361347198 43.5580406189, -8.08944511414 43.6619300842, -7.86583423615 43.7722091675, -7.85083389282 43.7147102356, -7.89916706085 43.6702690125, -7.85444498062 43.6683197021, -7.79083299637 43.7341499329, -7.68583393097 43.7744293213, -7.69361209869 43.7308197021, -7.6055560112 43.7133293152, -7.57055616379 43.7116508484, -7.484167099 43.727771759, -7.24888896942 43.5791511536, -7.03888893127 43.5574913025, -7.04527902603 43.4899902344, -6.94361114502 43.5777702332, -6.34972286224 43.5586013794, -6.16361093521 43.5722084045, -5.95472192764 43.5805397034, -5.8519449234 43.652759552, -5.52916717529 43.5485992432, -5.39805603027 43.5524902344, -5.38139009476 43.5261001587, -5.28888893127 43.533870697, -5.2147231102 43.4797096252, -4.69222307205 43.4174880981, -4.21694517136 43.3938789368, -4.05139017105 43.442489624, -3.82361102104 43.4488792419, -3.79722309113 43.4122085571, -3.65416693687 43.4916496277, -3.51555609703 43.4908218384, -3.43055605888 43.4644317627, -3.46055603027 43.4422111511, -3.42972207069 43.4110984802, -3.23138904572 43.3983192444, -3.11861109734 43.350818634, -3.00916695595 43.3810997009, -2.94166707993 43.4355506897, -2.72833299637 43.425819397, -2.29555606842 43.2961006165, -1.87999999523 43.3449897766, -1.81048798561 43.3858909607, -1.65583300591 43.3094291687, -1.62000000477 43.2563781738, -1.40916705132 43.2730407715, -1.381945014 43.1966514587, -1.47277796268 43.091091156, -1.44055604935 43.0483207703, -1.36027801037 43.0316505432, -1.28833305836 43.1060905457, -1.30055594444 43.0716590881, -0.818888902664 42.9460906982, -0.74694442749 42.9655418396, -0.656111121178 42.8636016846, -0.519166707993 42.7908210754, -0.500833392143 42.8222084045, -0.392222195864 42.7963790894, -0.306666702032 42.8491516113, -0.187777802348 42.7858200073, -0.123888902366 42.7574882507, -0.0575000010431 42.6941490173, 0.261944413185 42.7174797058, 0.291111111641 42.675819397, 0.41249999404 42.6952590942, 0.676110982895 42.6891517639, 0.668055415154 42.7480392456, 0.667777717113 42.8391494751, 0.815833091736 42.841091156, 1.38361096382 42.6897010803, 1.43524694443 42.5971488953)))'
        wkt = self.shapefile_support.get_shape_geometry(self.simple_shapefile, 'Spain')
        self.assertEqual(expected_wkt, wkt)


    def test_get_shape_bounding_box_for_point(self):
        expected_bb = '8.382651,54.640602,8.382653,54.640604'
        bb = self.shapefile_support.get_bounding_box(self.point_shapefile, '1')
        self.assertEqual(expected_bb, bb)


    def test_get_shape_bounding_box_reprojected(self):
        expected_bb = '8.4853028091,53.9356969648,8.48537786096,53.9357871676'
        bb = self.shapefile_support.get_bounding_box(self.projected_shapefile, 'Schlick')
        self.assertEqual(expected_bb, bb)


    def test_get_bounding_box_from_wkt(self):
        bb = geometry_support.get_bounding_box('POLYGON ((-1 2, 1.5 5, 4 1.5, 4 -1.5, 1.5 -2))')
        self.assertEqual('-1.0,-2.0,4.0,5.0', bb)


    def test_get_shape_from_geometry(self):
        shape = geometry_support.get_shape('POLYGON ((-1 2, 1.5 5, 4 1.5, 4 -1.5, 1.5 -2, -1 2))')
        geom = shape.getGeometry()

        self.assertEqual(6, geom.getNumPoints())

        self.assertEqual(-1, geom.getCoordinates()[0].x)
        self.assertEqual(2, geom.getCoordinates()[0].y)

        self.assertEqual(1.5, geom.getCoordinates()[4].x)
        self.assertEqual(-2, geom.getCoordinates()[4].y)

        self.assertEqual(-1, geom.getCoordinates()[5].x)
        self.assertEqual(2, geom.getCoordinates()[5].y)


    def test_get_mask_rectangular(self):
        geometry = 'POLYGON ((-10 45, -10 40, 10 40, 10 45, -10 45))'
        mask = geometry_support.create_mask(self.product, geometry)
        mask_pixel = np.ones(1, np.int32)

        self.assertIsNotNone(mask)

        for i in range(1000):
            x = random.randrange(self.product.getSceneRasterWidth())  # any x
            y = random.randrange(30)  # index of first line that is not masked
            mask.readPixels(x, y, 1, 1, mask_pixel)
            self.assertEqual(255, mask_pixel[0])

        for i in range(1000):
            x = random.randrange(self.product.getSceneRasterWidth())  # any x
            y = random.randrange(31, self.product.getSceneRasterHeight() - 1)
            mask.readPixels(x, y, 1, 1, mask_pixel)
            self.assertEqual(0, mask_pixel[0])


    def test_get_mask_polygonal(self):
        polygon = 'POLYGON ((-3.53125 40.28125, -0.78125 42.53125, 1.59375 39.15625, -3.53125 40.28125))'
        mask = geometry_support.create_mask(self.product, polygon)
        self.assertIsNotNone(mask)

        mask_pixels = np.zeros(self.product.getSceneRasterWidth(), np.int32)

        for y in range(self.product.getSceneRasterHeight()):
            mask.readPixels(0, y, self.product.getSceneRasterWidth(), 1, mask_pixels)
            if y < 10 or y > 37:
                self.assertEqual(0, np.sum(mask_pixels))
            self.assertEqual(0, np.sum(mask_pixels[:12]))
            self.assertEqual(0, np.sum(mask_pixels[54:]))

            if y == 20:
                self.assertEqual(0, mask_pixels[22])
                for x in range(23, 43):
                    self.assertEqual(255, mask_pixels[x])
                self.assertEqual(0, np.sum(mask_pixels[43:]))


class DummyDb():

    def __init__(self):
        self.shapes = []


    def get_shape_names(self, shapefile_path):
        return None


    def get_shape(self, shape_name, shapefile_path):
        for shape in self.shapes:
            if str(shape.name) == str(shape_name):  # str-calls in case that name is integer; ugly but required
                return shape
        raise ValueError('shape ' + shape_name + ' not found')


if __name__ == '__main__':
    unittest.main()